name: DOCX-MD Converter

on:
  push:
    paths:
      - 'MS-Word/**/*.docx'     # Only looks for word documents in MS-Word
      - '.github/workflows/doc-convert.yml'
  workflow_dispatch:            

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Sync Markdown with DOCX
        run: |
          mkdir -p media
          
          # 1. Convert all existing docx to md
          echo "Conversion in progress..."
          for f in MS-Word/*.docx; do
            [ -f "$f" ] || continue
            base=$(basename "$f" .docx)
            echo "Converting: $f â†’ $base.md"
            pandoc "$f" -f docx -t gfm --extract-media=media -o "$base.md"
            
            # Add auto-generated marker if not already present
            if ! grep -q "AUTO-GENERATED FROM DOCX" "$base.md"; then
              sed -i '1i <!-- AUTO-GENERATED FROM DOCX: DO NOT EDIT -->\n' "$base.md"
            fi
          done

          # 2. Remove orphaned auto-generated .md files and their media folders
          echo "Searching for orphaned files..."
          for m in *.md; do
            [ "$m" = "README.md" ] && continue
            if grep -q "AUTO-GENERATED FROM DOCX" "$m"; then
              base=$(basename "$m" .md)
              if [ ! -f "MS-Word/$base.docx" ]; then
                echo "Deleting orphaned generated file: $m and media/$base/"
                rm "$m"
                rm -rf "media/$base"
              fi
            fi
          done

      - name: Ensure media folder exists
        run: |
          mkdir -p media
          touch media/.keep

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Match DOCX to Markdown"
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          push: true
          github_token: ${{ secrets.GH_PAT }}

